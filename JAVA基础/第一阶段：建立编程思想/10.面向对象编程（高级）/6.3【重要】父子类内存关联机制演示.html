<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Javaçˆ¶å­ç±»å†…å­˜å…³è”å¯è§†åŒ–</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0d1117;
            --bg-darker: #010409;
            --bg-card: #161b22;
            --bg-elevated: #1c2128;
            --border: #30363d;

            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;

            --blue: #58a6ff;
            --purple: #bc8cff;
            --green: #3fb950;
            --orange: #f78166;
            --yellow: #d29922;
            --red: #ff7b72;
            --pink: #ff80cc;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-darker);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .header {
            background: var(--bg-dark);
            border-bottom: 1px solid var(--border);
            padding: 2rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(120deg, var(--blue), var(--purple), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .controls {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem auto;
            max-width: 1400px;
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
        }

        button {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover:not(:disabled) {
            background: var(--bg-dark);
            border-color: var(--blue);
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--blue);
            color: var(--bg-dark);
            border-color: var(--blue);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .step-info {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--blue);
        }

        .step-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--blue);
            margin-bottom: 1rem;
        }

        .step-description {
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .memory-view {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .memory-region {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            min-height: 400px;
        }

        .region-header {
            background: var(--bg-elevated);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .region-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .icon-metaspace {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .icon-heap {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .icon-instance {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .region-title {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .region-content {
            padding: 1.5rem;
        }

        .klass-object {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 2px solid rgba(102, 126, 234, 0.4);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .klass-object.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .klass-header {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--purple);
            font-size: 1.125rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
        }

        .klass-field {
            background: var(--bg-elevated);
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        .field-name {
            color: var(--blue);
            white-space: nowrap;
        }

        .field-value {
            color: var(--text-secondary);
            margin-left: auto;
            white-space: nowrap;
        }

        .class-object {
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.1), rgba(245, 87, 108, 0.1));
            border: 2px solid rgba(240, 147, 251, 0.4);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .class-object.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .class-header {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--pink);
            font-size: 1.125rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(240, 147, 251, 0.3);
        }

        .instance-object {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1));
            border: 2px solid rgba(79, 172, 254, 0.4);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .instance-object.visible {
            opacity: 1;
            transform: scale(1);
        }

        .instance-header {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--blue);
            font-size: 1.125rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(79, 172, 254, 0.3);
        }

        .vtable {
            background: var(--bg-elevated);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .vtable-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--yellow);
            margin-bottom: 0.75rem;
        }

        .vtable-entry {
            padding: 0.5rem;
            background: var(--bg-dark);
            border-radius: 4px;
            margin-bottom: 0.25rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
        }

        .vtable-index {
            color: var(--text-muted);
        }

        .vtable-method {
            color: var(--green);
        }

        .vtable-method.overridden {
            color: var(--orange);
            font-weight: 600;
        }

        .arrow {
            fill: none;
            stroke: var(--blue);
            stroke-width: 2;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .arrow.visible {
            opacity: 0.6;
        }

        .arrow-label {
            fill: var(--blue);
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .arrow-label.visible {
            opacity: 1;
        }

        .highlight {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(88, 166, 255, 0.4);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(88, 166, 255, 0);
            }
        }

        .legend {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--blue);
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .code-example {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .code-example pre {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            overflow-x: auto;
        }

        @media (max-width: 1200px) {
            .memory-view {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="header">
    <h1>Java çˆ¶å­ç±»å†…å­˜å…³è”å¯è§†åŒ–</h1>
    <p class="subtitle">æ·±åº¦å‰–æç»§æ‰¿æœºåˆ¶åœ¨JVMä¸­çš„å®ç°</p>
</div>

<div class="controls">
    <button id="resetBtn">â†º é‡ç½®</button>
    <button id="prevBtn">â—€ ä¸Šä¸€æ­¥</button>
    <button id="playBtn" class="btn-primary">
        <span id="playIcon">â–¶</span> <span id="playText">æ’­æ”¾</span>
    </button>
    <button id="nextBtn">ä¸‹ä¸€æ­¥ â–¶</button>
    <select id="speedSelect">
        <option value="2000">æ…¢é€Ÿ</option>
        <option value="1500" selected>æ­£å¸¸</option>
        <option value="800">å¿«é€Ÿ</option>
    </select>
</div>

<div class="container">
    <div class="step-info">
        <div class="step-title" id="stepTitle">å‡†å¤‡å¼€å§‹</div>
        <div class="step-description" id="stepDescription">
            ç‚¹å‡»æ’­æ”¾æŒ‰é’®ï¼Œè§‚å¯Ÿçˆ¶ç±»Parentå’Œå­ç±»Childåœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„å†…å­˜å…³è”å»ºç«‹è¿‡ç¨‹ã€‚
        </div>
        <div class="code-example" id="codeExample"></div>
    </div>

    <div class="memory-view">
        <div class="memory-region">
            <div class="region-header">
                <div class="region-icon icon-metaspace">ğŸ—„ï¸</div>
                <div class="region-title">å…ƒç©ºé—´ (Metaspace)</div>
            </div>
            <div class="region-content" id="metaspaceContent">
                <div class="empty-state">ç­‰å¾…ç±»åŠ è½½...</div>
            </div>
        </div>

        <div class="memory-region">
            <div class="region-header">
                <div class="region-icon icon-heap">ğŸ’</div>
                <div class="region-title">å † (Heap) - Classå¯¹è±¡</div>
            </div>
            <div class="region-content" id="heapContent">
                <div class="empty-state">ç­‰å¾…Classå¯¹è±¡åˆ›å»º...</div>
            </div>
        </div>

        <div class="memory-region">
            <div class="region-header">
                <div class="region-icon icon-instance">ğŸ“¦</div>
                <div class="region-title">å † (Heap) - å®ä¾‹å¯¹è±¡</div>
            </div>
            <div class="region-content" id="instanceContent">
                <div class="empty-state">ç­‰å¾…å¯¹è±¡å®ä¾‹åŒ–...</div>
            </div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-title">å›¾ä¾‹è¯´æ˜</div>
        <div class="legend-items">
            <div class="legend-item">
                <div class="legend-box" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                <span>InstanceKlassï¼ˆC++ç±»å…ƒæ•°æ®ï¼‰</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: linear-gradient(135deg, #f093fb, #f5576c);"></div>
                <span>Classå¯¹è±¡ï¼ˆJavaå±‚é¢ï¼Œjava.lang.Classï¼‰</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: linear-gradient(135deg, #4facfe, #00f2fe);"></div>
                <span>å¯¹è±¡å®ä¾‹</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: var(--blue);"></div>
                <span>å…³è”ç®­å¤´ï¼ˆ_super / superclass / Klass Pointer / mirrorï¼‰</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: var(--orange);"></div>
                <span>è¦†ç›–çš„æ–¹æ³•ï¼ˆOverrideï¼‰</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: var(--green);"></div>
                <span>ç»§æ‰¿çš„æ–¹æ³•</span>
            </div>
        </div>
    </div>
</div>

<svg id="connectionSvg" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50;">
    <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
            <polygon points="0 0, 10 3, 0 6" fill="var(--blue)" />
        </marker>
    </defs>
</svg>

<script>
    const steps = [
        {
            title: "åˆå§‹çŠ¶æ€",
            description: "ç¨‹åºå¯åŠ¨å‰ï¼Œæ‰€æœ‰ç±»éƒ½æœªåŠ è½½ã€‚æˆ‘ä»¬å°†è¦åŠ è½½Parentç±»å’ŒChildç±»ï¼Œå¹¶è§‚å¯Ÿå®ƒä»¬åœ¨å†…å­˜ä¸­çš„å…³è”ã€‚",
            code: `class Parent {
static int parentStatic = 100;
int parentInstance = 200;

public void show() {
    System.out.println("Parent");
}
}

class Child extends Parent {
static int childStatic = 300;
int childInstance = 400;

@Override
public void show() {
    System.out.println("Child");
}
}`,
            metaspace: [],
            heap: [],
            instance: [],
            arrows: []
        },
        {
            title: "æ­¥éª¤1ï¼šåŠ è½½Parentç±» - åˆ›å»ºInstanceKlass",
            description: "JVMé¦–å…ˆåœ¨å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰åˆ›å»ºParentç±»çš„InstanceKlassç»“æ„ã€‚è¿™æ˜¯C++å±‚é¢çš„ç±»å…ƒæ•°æ®ï¼ŒåŒ…å«ç±»çš„æ‰€æœ‰ç»“æ„ä¿¡æ¯ã€‚",
            code: `// C++ å±‚é¢ï¼ˆç®€åŒ–ï¼‰
class InstanceKlass {
InstanceKlass* _super;  // â†’ Object.InstanceKlass
Array<Method*>* _methods;
klassVtable _vtable;
// ...
}`,
            metaspace: [
                {
                    name: 'Parent.InstanceKlass',
                    fields: [
                        { name: '_super', value: 'â†’ Object' },
                        { name: '_methods', value: '[show(), ...]' },
                        { name: '_fields', value: '[parentStatic, parentInstance]' }
                    ],
                    vtable: [
                        { index: 0, method: 'Object.toString()' },
                        { index: 1, method: 'Object.equals()' },
                        { index: 2, method: 'Object.hashCode()' },
                        { index: 10, method: 'Parent.show()' }
                    ]
                }
            ],
            heap: [],
            instance: [],
            arrows: []
        },
        {
            title: "æ­¥éª¤2ï¼šåˆ›å»ºParent.classå¯¹è±¡",
            description: "åœ¨å †ä¸­åˆ›å»ºParentç±»çš„java.lang.Classå¯¹è±¡ã€‚è¿™æ˜¯Javaå±‚é¢çš„ç±»å¯¹è±¡ï¼ŒåŒ…å«superclasså­—æ®µæŒ‡å‘çˆ¶ç±»ï¼ˆObject.classï¼‰ï¼Œä»¥åŠé™æ€å˜é‡ã€‚",
            code: `// Java å±‚é¢
class Class<T> {
Class<? super T> superclass;  // â†’ Object.class
// ... å…¶ä»–å­—æ®µ
}

// Parent.class å¯¹è±¡åœ¨å †ä¸­
Parent.class.superclass = Object.class
Parent.class.parentStatic = 100`,
            metaspace: [
                {
                    name: 'Parent.InstanceKlass',
                    fields: [
                        { name: '_super', value: 'â†’ Object' },
                        { name: '_methods', value: '[show(), ...]' },
                        { name: '_fields', value: '[parentStatic, parentInstance]' }
                    ],
                    vtable: [
                        { index: 0, method: 'Object.toString()' },
                        { index: 1, method: 'Object.equals()' },
                        { index: 2, method: 'Object.hashCode()' },
                        { index: 10, method: 'Parent.show()' }
                    ]
                }
            ],
            heap: [
                {
                    name: 'Parent.class',
                    fields: [
                        { name: 'superclass', value: 'â†’ Object.class' },
                        { name: 'parentStatic', value: '100' },
                        { name: 'name', value: '"Parent"' }
                    ]
                }
            ],
            instance: [],
            arrows: []
        },
        {
            title: "æ­¥éª¤3ï¼šåŠ è½½Childç±» - åˆ›å»ºInstanceKlass",
            description: "åœ¨å…ƒç©ºé—´åˆ›å»ºChildç±»çš„InstanceKlassã€‚æ³¨æ„ï¼š_superå­—æ®µæŒ‡å‘Parent.InstanceKlassï¼Œå»ºç«‹C++å±‚é¢çš„ç»§æ‰¿å…³è”ã€‚",
            code: `// C++ å±‚é¢
Child.InstanceKlass {
_super = Parent.InstanceKlass  // â­ å…³é”®å…³è”
_methods = [show(é‡å†™), childMethod(), ...]
_vtable = ç»§æ‰¿è‡ªParentçš„vtable
}`,
            metaspace: [
                {
                    name: 'Parent.InstanceKlass',
                    fields: [
                        { name: '_super', value: 'â†’ Object' },
                        { name: '_methods', value: '[show(), ...]' },
                        { name: '_fields', value: '[parentStatic, parentInstance]' }
                    ],
                    vtable: [
                        { index: 0, method: 'Object.toString()' },
                        { index: 1, method: 'Object.equals()' },
                        { index: 2, method: 'Object.hashCode()' },
                        { index: 10, method: 'Parent.show()' }
                    ]
                },
                {
                    name: 'Child.InstanceKlass',
                    highlight: true,
                    fields: [
                        { name: '_super', value: 'â†’ Parent', highlight: true },
                        { name: '_methods', value: '[show(), childMethod(), ...]' },
                        { name: '_fields', value: '[childStatic, childInstance]' }
                    ],
                    vtable: [
                        { index: 0, method: 'Object.toString()' },
                        { index: 1, method: 'Object.equals()' },
                        { index: 2, method: 'Object.hashCode()' },
                        { index: 10, method: 'Child.show()', overridden: true },
                        { index: 11, method: 'Child.childMethod()' }
                    ]
                }
            ],
            heap: [
                {
                    name: 'Parent.class',
                    fields: [
                        { name: 'superclass', value: 'â†’ Object.class' },
                        { name: 'parentStatic', value: '100' },
                        { name: 'name', value: '"Parent"' }
                    ]
                }
            ],
            instance: [],
            arrows: [
                { from: 'Child.InstanceKlass', to: 'Parent.InstanceKlass', label: '_super' }
            ]
        },
        {
            title: "æ­¥éª¤4ï¼šåˆ›å»ºChild.classå¯¹è±¡",
            description: "åœ¨å †ä¸­åˆ›å»ºChildç±»çš„java.lang.Classå¯¹è±¡ã€‚superclasså­—æ®µæŒ‡å‘Parent.classï¼Œå»ºç«‹Javaå±‚é¢çš„ç»§æ‰¿å…³è”ã€‚",
            code: `// Java å±‚é¢
Child.class {
superclass = Parent.class  // â­ å…³é”®å…³è”
childStatic = 300
name = "Child"
}

// åå°„è®¿é—®
Child.class.getSuperclass() == Parent.class  // true`,
            metaspace: [
                {
                    name: 'Parent.InstanceKlass',
                    fields: [
                        { name: '_super', value: 'â†’ Object' },
                        { name: '_methods', value: '[show(), ...]' },
                        { name: '_fields', value: '[parentStatic, parentInstance]' }
                    ],
                    vtable: [
                        { index: 0, method: 'Object.toString()' },
                        { index: 1, method: 'Object.equals()' },
                        { index: 2, method: 'Object.hashCode()' },
                        { index: 10, method: 'Parent.show()' }
                    ]
                },
                {
                    name: 'Child.InstanceKlass',
                    fields: [
                        { name: '_super', value: 'â†’ Parent' },
                        { name: '_methods', value: '[show(), childMethod(), ...]' },
                        { name: '_fields', value: '[childStatic, childInstance]' }
                    ],
                    vtable: [
                        { index: 0, method: 'Object.toString()' },
                        { index: 1, method: 'Object.equals()' },
                        { index: 2, method: 'Object.hashCode()' },
                        { index: 10, method: 'Child.show()', overridden: true },
                        { index: 11, method: 'Child.childMethod()' }
                    ]
                }
            ],
            heap: [
                {
                    name: 'Parent.class',
                    fields: [
                        { name: 'superclass', value: 'â†’ Object.class' },
                        { name: 'parentStatic', value: '100' },
                        { name: 'name', value: '"Parent"' }
                    ]
                },
                {
                    name: 'Child.class',
                    highlight: true,
                    fields: [
                        { name: 'superclass', value: 'â†’ Parent.class', highlight: true },
                        { name: 'childStatic', value: '300' },
                        { name: 'name', value: '"Child"' }
                    ]
                }
            ],
            instance: [],
            arrows: [
                { from: 'Child.InstanceKlass', to: 'Parent.InstanceKlass', label: '_super' },
                { from: 'Child.class', to: 'Parent.class', label: 'superclass' }
            ]
        },
        {
            title: "æ­¥éª¤5ï¼šè™šæ–¹æ³•è¡¨ï¼ˆvtableï¼‰çš„ç»§æ‰¿",
            description: "Childçš„vtableç»§æ‰¿è‡ªParentã€‚æ³¨æ„ç´¢å¼•10çš„æ–¹æ³•ï¼šParentä¸­æ˜¯Parent.show()ï¼ŒChildä¸­è¢«è¦†ç›–ä¸ºChild.show()ã€‚è¿™æ˜¯å¤šæ€çš„å…³é”®ï¼",
            code: `// vtable å¯¹æ¯”
Parent.vtable[10] = Parent.show()
Child.vtable[10]  = Child.show()  // è¦†ç›–ï¼

// æ–¹æ³•è°ƒç”¨
Parent obj = new Child();
obj.show();  // invokevirtual

// è¿è¡Œæ—¶æŸ¥æ‰¾ï¼š
// 1. è·å–objçš„å®é™…ç±»å‹ â†’ Child
// 2. åœ¨Child.vtableä¸­æŸ¥æ‰¾ â†’ vtable[10]
// 3. æ‰§è¡Œ Child.show()  // å¤šæ€ï¼`,
            metaspace: [
                {
                    name: 'Parent.InstanceKlass',
                    fields: [
                        { name: '_super', value: 'â†’ Object' },
                        { name: '_methods', value: '[show(), ...]' },
                        { name: '_fields', value: '[parentStatic, parentInstance]' }
                    ],
                    vtable: [
                        { index: 0, method: 'Object.toString()' },
                        { index: 1, method: 'Object.equals()' },
                        { index: 2, method: 'Object.hashCode()' },
                        { index: 10, method: 'Parent.show()', highlight: true }
                    ]
                },
                {
                    name: 'Child.InstanceKlass',
                    fields: [
                        { name: '_super', value: 'â†’ Parent' },
                        { name: '_methods', value: '[show(), childMethod(), ...]' },
                        { name: '_fields', value: '[childStatic, childInstance]' }
                    ],
                    vtable: [
                        { index: 0, method: 'Object.toString()' },
                        { index: 1, method: 'Object.equals()' },
                        { index: 2, method: 'Object.hashCode()' },
                        { index: 10, method: 'Child.show()', overridden: true, highlight: true },
                        { index: 11, method: 'Child.childMethod()' }
                    ]
                }
            ],
            heap: [
                {
                    name: 'Parent.class',
                    fields: [
                        { name: 'superclass', value: 'â†’ Object.class' },
                        { name: 'parentStatic', value: '100' },
                        { name: 'name', value: '"Parent"' }
                    ]
                },
                {
                    name: 'Child.class',
                    fields: [
                        { name: 'superclass', value: 'â†’ Parent.class' },
                        { name: 'childStatic', value: '300' },
                        { name: 'name', value: '"Child"' }
                    ]
                }
            ],
            instance: [],
            arrows: [
                { from: 'Child.InstanceKlass', to: 'Parent.InstanceKlass', label: '_super' },
                { from: 'Child.class', to: 'Parent.class', label: 'superclass' }
            ]
        },

        /* âœ… ä¿®æ­£ç‰ˆï¼šæ­¥éª¤6ï¼ˆKlass Pointer æŒ‡å‘å…ƒç©ºé—´ InstanceKlassï¼›Class æ˜¯ mirrorï¼‰ */
        {
            title: "æ­¥éª¤6ï¼šåˆ›å»ºChildå®ä¾‹ - å­—æ®µå¸ƒå±€ï¼ˆä¿®æ­£ç‰ˆï¼‰",
            description: "åˆ›å»ºChildå¯¹è±¡å®ä¾‹ã€‚æ³¨æ„ï¼šå®ä¾‹åŒ…å«å®Œæ•´ç»§æ‰¿é“¾çš„æ‰€æœ‰å®ä¾‹å˜é‡ã€‚çˆ¶ç±»å­—æ®µåœ¨å‰ï¼Œå­ç±»å­—æ®µåœ¨åã€‚å¯¹è±¡å¤´ä¸­ä¿å­˜çš„æ˜¯KlassæŒ‡é’ˆï¼ˆç±»å…ƒæ•°æ®æŒ‡é’ˆï¼‰ï¼ŒæŒ‡å‘å…ƒç©ºé—´ä¸­çš„Child.InstanceKlassï¼Œè€Œä¸æ˜¯æŒ‡å‘å †ä¸­çš„Child.classã€‚",
            code: `// å¯¹è±¡å®ä¾‹çš„å†…å­˜å¸ƒå±€ï¼ˆHotSpot è¯­ä¹‰åŒ–è¡¨è¾¾ï¼‰
Childå®ä¾‹å¯¹è±¡ {
å¯¹è±¡å¤´: {
    Mark Word (8å­—èŠ‚)
    Klass Pointer â†’ Child.InstanceKlass (Metaspace)  // â­ ä¸æ˜¯ â†’ Child.class
}

// çˆ¶ç±»å­—æ®µï¼ˆç¤ºä¾‹åç§»é‡ï¼‰
parentInstance = 200

// å­ç±»å­—æ®µï¼ˆç¤ºä¾‹åç§»é‡ï¼‰
childInstance = 400

å¯¹é½å¡«å……
}`,
            metaspace: [
                {
                    name: 'Parent.InstanceKlass',
                    fields: [
                        { name: '_super', value: 'â†’ Object' },
                        { name: '_methods', value: '[show(), ...]' },
                        { name: '_fields', value: '[parentStatic, parentInstance]' }
                    ],
                    vtable: [
                        { index: 0, method: 'Object.toString()' },
                        { index: 1, method: 'Object.equals()' },
                        { index: 2, method: 'Object.hashCode()' },
                        { index: 10, method: 'Parent.show()' }
                    ]
                },
                {
                    name: 'Child.InstanceKlass',
                    fields: [
                        { name: '_super', value: 'â†’ Parent' },
                        { name: '_methods', value: '[show(), childMethod(), ...]' },
                        { name: '_fields', value: '[childStatic, childInstance]' }
                    ],
                    vtable: [
                        { index: 0, method: 'Object.toString()' },
                        { index: 1, method: 'Object.equals()' },
                        { index: 2, method: 'Object.hashCode()' },
                        { index: 10, method: 'Child.show()', overridden: true },
                        { index: 11, method: 'Child.childMethod()' }
                    ]
                }
            ],
            heap: [
                {
                    name: 'Parent.class',
                    fields: [
                        { name: 'superclass', value: 'â†’ Object.class' },
                        { name: 'parentStatic', value: '100' },
                        { name: 'name', value: '"Parent"' }
                    ]
                },
                {
                    name: 'Child.class',
                    fields: [
                        { name: 'superclass', value: 'â†’ Parent.class' },
                        { name: 'childStatic', value: '300' },
                        { name: 'name', value: '"Child"' },
                        { name: 'mirror/metadata', value: 'â†” Child.InstanceKlass', highlight: true }
                    ]
                }
            ],
            instance: [
                {
                    name: 'Child@instance',
                    highlight: true,
                    fields: [
                        { name: 'å¯¹è±¡å¤´.KlassæŒ‡é’ˆ', value: 'â†’ Child.InstanceKlass', highlight: true },
                        { name: 'parentInstance', value: '200', comment: 'æ¥è‡ªParent' },
                        { name: 'childInstance', value: '400', comment: 'æ¥è‡ªChild' }
                    ]
                }
            ],
            arrows: [
                { from: 'Child.InstanceKlass', to: 'Parent.InstanceKlass', label: '_super' },
                { from: 'Child.class', to: 'Parent.class', label: 'superclass' },

                // âœ… å…³é”®ä¿®æ­£ï¼šå®ä¾‹å¯¹è±¡å¤´æŒ‡å‘å…ƒç©ºé—´çš„InstanceKlass
                { from: 'Child@instance', to: 'Child.InstanceKlass', label: 'Klass Pointer' },

                // âœ… æ›´å®Œæ•´ï¼šClasså¯¹è±¡ä¸å…ƒæ•°æ®çš„ mirror å…³ç³»
                { from: 'Child.class', to: 'Child.InstanceKlass', label: 'mirror' }
            ]
        },

        /* âœ… ä¿®æ­£ç‰ˆï¼šå®Œæ•´å…³è”å›¾ï¼ˆè¡¥é½ KlassPointer + mirrorï¼‰ */
        {
            title: "å®Œæ•´å…³è”å›¾ï¼ˆä¿®æ­£ç‰ˆï¼‰",
            description: "æ€»ç»“ï¼šçˆ¶å­ç±»åœ¨ä¸‰ä¸ªå±‚é¢å»ºç«‹å…³è”ã€‚â‘  å…ƒæ•°æ®å±‚ï¼šInstanceKlass._superæŒ‡é’ˆï¼ˆå…ƒç©ºé—´ï¼‰ã€‚â‘¡ Javaåå°„å±‚ï¼šClass.superclasså­—æ®µï¼ˆå †ä¸­çš„java.lang.Classå¯¹è±¡ï¼‰ã€‚â‘¢ å®ä¾‹å±‚ï¼šå¯¹è±¡å¤´é‡Œæ˜¯Klass Pointerï¼Œç›´æ¥æŒ‡å‘å…ƒç©ºé—´çš„InstanceKlassï¼›java.lang.Classå¯¹è±¡ä½œä¸ºKlassçš„mirrorä¸å…¶å…³è”ã€‚",
            code: `// ä¸‰å±‚å…³è”æ€»ç»“ï¼ˆæ›´è´´è¿‘ HotSpot è¯­ä¹‰ï¼‰

// 1) å…ƒæ•°æ®å±‚ï¼ˆMetaspaceï¼ŒC++/JVMå±‚ï¼‰
Child.InstanceKlass._super â†’ Parent.InstanceKlass

// 2) Java åå°„å±‚ï¼ˆHeapä¸­çš„ java.lang.Classï¼‰
Child.class.superclass â†’ Parent.class

// 3) å®ä¾‹å±‚ï¼ˆHeapä¸­çš„å¯¹è±¡å®ä¾‹ï¼‰
childå®ä¾‹.å¯¹è±¡å¤´.KlassPointer â†’ Child.InstanceKlass   // â­ ä¸æ˜¯ â†’ Child.class

// 4) mirror å…³ç³»ï¼ˆClasså¯¹è±¡ä¸å…ƒæ•°æ®çš„å…³è”ï¼‰
Child.class â†” Child.InstanceKlass

// æ–¹æ³•è°ƒç”¨ï¼ˆå¤šæ€ï¼Œæ¦‚å¿µåŒ–é“¾è·¯ï¼‰
childå®ä¾‹ â†’ Child.InstanceKlass â†’ vtable[index] â†’ å®é™…æ–¹æ³•`,
            metaspace: [
                {
                    name: 'Parent.InstanceKlass',
                    fields: [
                        { name: '_super', value: 'â†’ Object' },
                        { name: '_methods', value: '[show(), ...]' },
                        { name: '_fields', value: '[parentStatic, parentInstance]' }
                    ],
                    vtable: [
                        { index: 0, method: 'Object.toString()' },
                        { index: 1, method: 'Object.equals()' },
                        { index: 2, method: 'Object.hashCode()' },
                        { index: 10, method: 'Parent.show()' }
                    ]
                },
                {
                    name: 'Child.InstanceKlass',
                    fields: [
                        { name: '_super', value: 'â†’ Parent', highlight: true },
                        { name: '_methods', value: '[show(), childMethod(), ...]' },
                        { name: '_fields', value: '[childStatic, childInstance]' }
                    ],
                    vtable: [
                        { index: 0, method: 'Object.toString()' },
                        { index: 1, method: 'Object.equals()' },
                        { index: 2, method: 'Object.hashCode()' },
                        { index: 10, method: 'Child.show()', overridden: true },
                        { index: 11, method: 'Child.childMethod()' }
                    ]
                }
            ],
            heap: [
                {
                    name: 'Parent.class',
                    fields: [
                        { name: 'superclass', value: 'â†’ Object.class' },
                        { name: 'parentStatic', value: '100' },
                        { name: 'name', value: '"Parent"' }
                    ]
                },
                {
                    name: 'Child.class',
                    fields: [
                        { name: 'superclass', value: 'â†’ Parent.class', highlight: true },
                        { name: 'childStatic', value: '300' },
                        { name: 'name', value: '"Child"' },
                        { name: 'mirror/metadata', value: 'â†” Child.InstanceKlass', highlight: true }
                    ]
                }
            ],
            instance: [
                {
                    name: 'Child@instance',
                    fields: [
                        { name: 'å¯¹è±¡å¤´.KlassæŒ‡é’ˆ', value: 'â†’ Child.InstanceKlass', highlight: true },
                        { name: 'parentInstance', value: '200', comment: 'æ¥è‡ªParent' },
                        { name: 'childInstance', value: '400', comment: 'æ¥è‡ªChild' }
                    ]
                }
            ],
            arrows: [
                { from: 'Child.InstanceKlass', to: 'Parent.InstanceKlass', label: '_super' },
                { from: 'Child.class', to: 'Parent.class', label: 'superclass' },
                { from: 'Child@instance', to: 'Child.InstanceKlass', label: 'Klass Pointer' },
                { from: 'Child.class', to: 'Child.InstanceKlass', label: 'mirror' }
            ]
        }
    ];

    let currentStep = 0;
    let isPlaying = false;
    let playTimer = null;
    let playSpeed = 1500;

    function renderStep() {
        const step = steps[currentStep];

        // æ›´æ–°è¯´æ˜
        document.getElementById('stepTitle').textContent = step.title;
        document.getElementById('stepDescription').textContent = step.description;
        document.getElementById('codeExample').innerHTML = `<pre>${escapeHtml(step.code)}</pre>`;

        // æ›´æ–°å…ƒç©ºé—´
        renderMetaspace(step.metaspace);

        // æ›´æ–°å †
        renderHeap(step.heap);

        // æ›´æ–°å®ä¾‹
        renderInstance(step.instance);

        // æ›´æ–°ç®­å¤´ï¼ˆå»¶è¿Ÿæ¸²æŸ“ï¼‰
        setTimeout(() => renderArrows(step.arrows), 500);

        // æ›´æ–°æŒ‰é’®
        updateButtons();
    }

    function renderMetaspace(items) {
        const container = document.getElementById('metaspaceContent');
        if (items.length === 0) {
            container.innerHTML = '<div class="empty-state">ç­‰å¾…ç±»åŠ è½½...</div>';
            return;
        }

        const html = items.map(item => {
            const fieldsHtml = item.fields.map(f => `
                <div class="klass-field ${f.highlight ? 'highlight' : ''}">
                    <span class="field-name">${f.name}</span>
                    <span class="field-value">${f.value}</span>
                </div>
            `).join('');

            const vtableHtml = item.vtable ? `
                <div class="vtable">
                    <div class="vtable-title">è™šæ–¹æ³•è¡¨ (vtable)</div>
                    ${item.vtable.map(v => `
                        <div class="vtable-entry ${v.highlight ? 'highlight' : ''}">
                            <span class="vtable-index">[${v.index}]</span>
                            <span class="vtable-method ${v.overridden ? 'overridden' : ''}">${v.method}</span>
                        </div>
                    `).join('')}
                </div>
            ` : '';

            return `
                <div class="klass-object ${item.highlight ? 'highlight' : ''}" data-id="${item.name}">
                    <div class="klass-header">${item.name}</div>
                    ${fieldsHtml}
                    ${vtableHtml}
                </div>
            `;
        }).join('');

        container.innerHTML = html;

        // è§¦å‘åŠ¨ç”»
        setTimeout(() => {
            container.querySelectorAll('.klass-object').forEach(el => {
                el.classList.add('visible');
            });
        }, 10);
    }

    function renderHeap(items) {
        const container = document.getElementById('heapContent');
        if (items.length === 0) {
            container.innerHTML = '<div class="empty-state">ç­‰å¾…Classå¯¹è±¡åˆ›å»º...</div>';
            return;
        }

        const html = items.map(item => {
            const fieldsHtml = item.fields.map(f => `
                <div class="klass-field ${f.highlight ? 'highlight' : ''}">
                    <span class="field-name">${f.name}</span>
                    <span class="field-value">${f.value}</span>
                </div>
            `).join('');

            return `
                <div class="class-object ${item.highlight ? 'highlight' : ''}" data-id="${item.name}">
                    <div class="class-header">${item.name}</div>
                    ${fieldsHtml}
                </div>
            `;
        }).join('');

        container.innerHTML = html;

        setTimeout(() => {
            container.querySelectorAll('.class-object').forEach(el => {
                el.classList.add('visible');
            });
        }, 10);
    }

    function renderInstance(items) {
        const container = document.getElementById('instanceContent');
        if (items.length === 0) {
            container.innerHTML = '<div class="empty-state">ç­‰å¾…å¯¹è±¡å®ä¾‹åŒ–...</div>';
            return;
        }

        const html = items.map(item => {
            const fieldsHtml = item.fields.map(f => `
                <div class="klass-field ${f.highlight ? 'highlight' : ''}">
                    <span class="field-name">${f.name}</span>
                    <span class="field-value">${f.value}</span>
                    ${f.comment ? `<span class="field-value" style="font-size: 0.75rem; color: var(--text-muted); white-space: nowrap;">${f.comment}</span>` : ''}
                </div>
            `).join('');

            return `
                <div class="instance-object ${item.highlight ? 'highlight' : ''}" data-id="${item.name}">
                    <div class="instance-header">${item.name}</div>
                    ${fieldsHtml}
                </div>
            `;
        }).join('');

        container.innerHTML = html;

        setTimeout(() => {
            container.querySelectorAll('.instance-object').forEach(el => {
                el.classList.add('visible');
            });
        }, 10);
    }

    function renderArrows(arrows) {
        const svg = document.getElementById('connectionSvg');
        svg.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#58a6ff" /></marker></defs>';

        arrows.forEach(arrow => {
            const fromEl = document.querySelector(`[data-id="${arrow.from}"]`);
            const toEl = document.querySelector(`[data-id="${arrow.to}"]`);

            if (fromEl && toEl) {
                const fromRect = fromEl.getBoundingClientRect();
                const toRect = toEl.getBoundingClientRect();

                const x1 = fromRect.left + fromRect.width / 2;
                const y1 = fromRect.top + fromRect.height / 2;
                const x2 = toRect.left + toRect.width / 2;
                const y2 = toRect.top + toRect.height / 2;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M ${x1} ${y1} Q ${(x1+x2)/2} ${(y1+y2)/2-50} ${x2} ${y2}`);
                path.setAttribute('class', 'arrow');
                path.setAttribute('marker-end', 'url(#arrowhead)');
                svg.appendChild(path);

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', (x1+x2)/2);
                text.setAttribute('y', (y1+y2)/2 - 55);
                text.setAttribute('class', 'arrow-label');
                text.setAttribute('text-anchor', 'middle');
                text.textContent = arrow.label;
                svg.appendChild(text);

                setTimeout(() => {
                    path.classList.add('visible');
                    text.classList.add('visible');
                }, 10);
            }
        });
    }

    function updateButtons() {
        document.getElementById('prevBtn').disabled = currentStep === 0;
        document.getElementById('nextBtn').disabled = currentStep === steps.length - 1;
    }

    function goToStep(step) {
        currentStep = Math.max(0, Math.min(step, steps.length - 1));
        renderStep();
    }

    function nextStep() {
        if (currentStep < steps.length - 1) {
            goToStep(currentStep + 1);
        } else {
            stopPlay();
        }
    }

    function prevStep() {
        if (currentStep > 0) {
            goToStep(currentStep - 1);
        }
    }

    function togglePlay() {
        if (isPlaying) {
            stopPlay();
        } else {
            startPlay();
        }
    }

    function startPlay() {
        isPlaying = true;
        document.getElementById('playIcon').textContent = 'â¸';
        document.getElementById('playText').textContent = 'æš‚åœ';

        playTimer = setInterval(() => {
            nextStep();
        }, playSpeed);
    }

    function stopPlay() {
        isPlaying = false;
        document.getElementById('playIcon').textContent = 'â–¶';
        document.getElementById('playText').textContent = 'æ’­æ”¾';
        if (playTimer) {
            clearInterval(playTimer);
            playTimer = null;
        }
    }

    function reset() {
        stopPlay();
        goToStep(0);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // äº‹ä»¶ç›‘å¬
    document.getElementById('playBtn').addEventListener('click', togglePlay);
    document.getElementById('nextBtn').addEventListener('click', () => {
        stopPlay();
        nextStep();
    });
    document.getElementById('prevBtn').addEventListener('click', () => {
        stopPlay();
        prevStep();
    });
    document.getElementById('resetBtn').addEventListener('click', reset);
    document.getElementById('speedSelect').addEventListener('change', (e) => {
        playSpeed = parseInt(e.target.value);
        if (isPlaying) {
            stopPlay();
            startPlay();
        }
    });

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
            e.preventDefault();
            togglePlay();
        } else if (e.code === 'ArrowRight') {
            e.preventDefault();
            stopPlay();
            nextStep();
        } else if (e.code === 'ArrowLeft') {
            e.preventDefault();
            stopPlay();
            prevStep();
        }
    });

    // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°æ¸²æŸ“ç®­å¤´
    window.addEventListener('resize', () => {
        if (steps[currentStep].arrows) {
            renderArrows(steps[currentStep].arrows);
        }
    });

    // åˆå§‹åŒ–
    renderStep();
</script>
</body>
</html>

