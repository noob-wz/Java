## ç¬¬1éƒ¨åˆ†ï¼šå»ºç«‹è®¤çŸ¥ï¼ˆWhat & Whyï¼‰

### ğŸ“¦ 1.1 æ ¸å¿ƒè¯­æ³• *ğŸ’¡ æ ¸å¿ƒå¿…å­¦*

**ç›®æ ‡**ï¼šç†è§£ `hashCode` çš„æ–¹æ³•ç­¾åå’Œé»˜è®¤è¡Œä¸ºã€‚

**åŸºç¡€è¯­æ³•ç»“æ„**ï¼š
`hashCode` æ˜¯ `java.lang.Object` ç±»å®šä¹‰çš„æ–¹æ³•ï¼Œæ„å‘³ç€ Java ä¸­**ä»»ä½•å¯¹è±¡**éƒ½æœ‰è¿™ä¸ªæ–¹æ³•ã€‚

```java
// æ–¹æ³•ç­¾åï¼šè¿”å›ä¸€ä¸ª int ç±»å‹çš„æ•´æ•°
public native int hashCode();

```

* **ä¿®é¥°ç¬¦**ï¼š`public`ï¼ˆå…¬å¼€ï¼‰ï¼Œ`native`ï¼ˆæœ¬åœ°æ–¹æ³•ï¼Œåº•å±‚ç”± C++ å®ç°ï¼‰ã€‚
* **è¿”å›å€¼**ï¼š`int`ï¼ˆ32ä½æœ‰ç¬¦å·æ•´æ•°ï¼ŒèŒƒå›´ -2^31 åˆ° 2^31-1ï¼‰ã€‚
* **é»˜è®¤è¡Œä¸º**ï¼šåœ¨æœªé‡å†™çš„æƒ…å†µä¸‹ï¼Œå®ƒé€šå¸¸åŸºäºå¯¹è±¡çš„**å†…å­˜åœ°å€**è®¡ç®—ï¼ˆä½†è¿™å–å†³äº JVM å®ç°ï¼‰ï¼Œå¯ä»¥å°†å…¶ç†è§£ä¸ºå¯¹è±¡çš„"èº«ä»½è¯å·"ã€‚

**ç¤ºä¾‹ä»£ç **ï¼š

```java
public class User {
    private int id;
    private String name;

    // æ„é€ å™¨
    public User(int id, String name) {
        this.id = id;
        this.name = name;
    }

    // âŒ å¦‚æœä¸é‡å†™ hashCodeï¼Œä½¿ç”¨çš„æ˜¯ Object çš„é»˜è®¤å®ç°
    // ä¸¤ä¸ªå±æ€§å®Œå…¨ç›¸åŒçš„å¯¹è±¡ï¼Œå…¶ hashCode é€šå¸¸ä¸åŒ
}

public class Main {
    public static void main(String[] args) {
        User u1 = new User(1, "Alice");
        User u2 = new User(1, "Alice");

        // é»˜è®¤å®ç°ï¼šåŸºäºå¯¹è±¡èº«ä»½ï¼ˆå†…å­˜åœ°å€ï¼‰
        System.out.println(u1.hashCode()); // è¾“å‡ºï¼šæ¯”å¦‚ 1829164700
        System.out.println(u2.hashCode()); // è¾“å‡ºï¼šæ¯”å¦‚ 2018699554 (ä¸ç›¸ç­‰ï¼)
    }
}

```

---

### ğŸ”— 1.2 å…³è”æ¦‚å¿µ *ğŸ’¡ æ ¸å¿ƒå¿…å­¦*

**ç›®æ ‡**ï¼šç†è§£ `hashCode` å¿…é¡»éµå®ˆçš„"éœ¸ç‹æ¡æ¬¾"ã€‚

**å¿…é¡»åŒ…å«çš„å†…å®¹**ï¼š

1. **ä¸ `equals` çš„ç”Ÿæ­»å¥‘çº¦**ï¼š
   è¿™æ˜¯ Java ä¸­æœ€ä¸¥æ ¼çš„çº¦å®šä¹‹ä¸€ã€‚`hashCode` çš„å­˜åœ¨ä¸»è¦æ˜¯ä¸ºäº†é…åˆå“ˆå¸Œè¡¨ï¼ˆå¦‚ `HashMap`, `HashSet`ï¼‰ã€‚
* **é“å¾‹ 1**ï¼šå¦‚æœ `a.equals(b)` ä¸º `true`ï¼Œé‚£ä¹ˆ `a.hashCode()` å¿…é¡»ç­‰äº `b.hashCode()`ã€‚
* **é“å¾‹ 2**ï¼šå¦‚æœ `a.hashCode() == b.hashCode()`ï¼Œ`a.equals(b)` **ä¸ä¸€å®š**ä¸º `true`ï¼ˆè¿™å«**å“ˆå¸Œå†²çª**ï¼‰ã€‚


2. **å“ˆå¸Œå†²çª (Hash Collision)**ï¼š
* ç”±äº `int` çš„èŒƒå›´æœ‰é™ï¼ˆçº¦40äº¿ï¼‰ï¼Œè€Œå¯¹è±¡æ˜¯æ— é™çš„ï¼Œå¿…ç„¶ä¼šæœ‰ä¸åŒçš„å¯¹è±¡äº§ç”Ÿç›¸åŒçš„å“ˆå¸Œå€¼ã€‚
* **ç¼–è¯‘å™¨è¡Œä¸º**ï¼šç¼–è¯‘å™¨ä¸ä¼šè‡ªåŠ¨å¸®ä½ å¤„ç†å†²çªï¼Œè¿™æ˜¯ä½ éœ€è¦æ¥å—çš„æ•°å­¦äº‹å®ã€‚



**ä»£ç éªŒè¯ï¼ˆæ¦‚å¿µä¾èµ–é¡ºåºï¼šå…ˆè®²å¥‘çº¦ï¼Œå†æ¼”ç¤ºï¼‰**ï¼š

```java
// æ¼”ç¤ºå…³è”æ¦‚å¿µ
public class ConceptDemo {
    public static void main(String[] args) {
        String s1 = "Aa";
        String s2 = "BB";

        // 1. éªŒè¯å“ˆå¸Œå†²çªï¼ˆè¿™æ˜¯çœŸå®å­˜åœ¨çš„å·§åˆï¼‰
        System.out.println("s1 hash: " + s1.hashCode()); // 2112
        System.out.println("s2 hash: " + s2.hashCode()); // 2112
        
        // 2. éªŒè¯é“å¾‹2ï¼šHashç›¸ç­‰ï¼Œä½†å¯¹è±¡ä¸ç­‰
        boolean isSame = s1.equals(s2);
        System.out.println("å†…å®¹æ˜¯å¦ç›¸ç­‰: " + isSame); // false
        
        // è¿™è¯´æ˜ï¼šhashCode åªèƒ½ç”¨äº"å¿«é€Ÿè¿‡æ»¤"ï¼Œä¸èƒ½ç”¨äº"æœ€ç»ˆç¡®è®¤"
    }
}

```

---

### ğŸš€ 1.3 å¿«é€Ÿä¸Šæ‰‹ *ğŸ’¡ æ ¸å¿ƒå¿…å­¦*

**ç›®æ ‡**ï¼šå†™ä¸€ä¸ªèƒ½æ­£ç¡®é…åˆ `equals` å·¥ä½œçš„ `hashCode`ã€‚

**æœ€ç®€å•çš„å®Œæ•´ç¤ºä¾‹**ï¼š

```java
import java.util.Objects; // å¼•å…¥å·¥å…·ç±»

public class Product {
    private String sku;
    private double price;

    public Product(String sku, double price) {
        this.sku = sku;
        this.price = price;
    }

    // 1. é‡å†™ equals (é€»è¾‘ï¼šsku ç›¸åŒå³è§†ä¸ºåŒä¸€å•†å“)
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Product product = (Product) o;
        // ä½¿ç”¨ Objects å·¥å…·ç±»é˜²æ­¢ç©ºæŒ‡é’ˆ
        return Objects.equals(sku, product.sku);
    }

    // 2. é‡å†™ hashCode
    // âš ï¸ æ ¸å¿ƒåŸåˆ™ï¼šequals ç”¨åˆ°äº†å“ªäº›å­—æ®µï¼ŒhashCode å°±å¿…é¡»ç”¨å“ªäº›å­—æ®µè®¡ç®—
    @Override
    public int hashCode() {
        // ä½¿ç”¨ Java 7+ æä¾›çš„å·¥å…·æ–¹æ³•ï¼Œç®€å•ä¸”ç¬¦åˆè§„èŒƒ
        return Objects.hash(sku); 
    }

    public static void main(String[] args) {
        Product p1 = new Product("A100", 10.0);
        Product p2 = new Product("A100", 20.0); // åªè¦SKUç›¸åŒ

        System.out.println("Equals: " + p1.equals(p2));      // true
        System.out.println("Hash p1: " + p1.hashCode());     // æ¯”å¦‚ 2001
        System.out.println("Hash p2: " + p2.hashCode());     // æ¯”å¦‚ 2001 (å¿…é¡»ç›¸ç­‰ï¼)
    }
}

```

---

### ğŸ’¡ 1.4 å®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ *ğŸ’¡ æ ¸å¿ƒå¿…å­¦*

**ç›®æ ‡**ï¼šç†è§£ä¸ºä»€ä¹ˆä¸èƒ½åªç”¨ `equals`ã€‚

**åœºæ™¯**ï¼šå‡è®¾ä½ æœ‰ä¸€ä¸ªåŒ…å« 100 ä¸‡ä¸ªç”¨æˆ·çš„é›†åˆï¼Œç°åœ¨è¦æŸ¥æ‰¾æŸä¸ªç”¨æˆ·æ˜¯å¦å­˜åœ¨ã€‚

**æ²¡æœ‰ `hashCode` (List æŸ¥æ‰¾)**ï¼š
å¿…é¡»éå†æ•´ä¸ªåˆ—è¡¨ï¼Œè°ƒç”¨ 100 ä¸‡æ¬¡ `equals`ã€‚
å¤æ‚åº¦ï¼š - æ…¢å¾—åƒåœ¨å›¾ä¹¦é¦†æŒ¨ä¸ªä¹¦æ¶æ‰¾ä¹¦ã€‚

**æœ‰ `hashCode` (Map/Set æŸ¥æ‰¾)**ï¼š
ç›´æ¥è®¡ç®—ç›®æ ‡çš„å“ˆå¸Œå€¼ï¼Œç®—å‡ºå®ƒ"åº”è¯¥"åœ¨å†…å­˜çš„å“ªä¸ªä½ç½®ã€‚
å¤æ‚åº¦ï¼š - å¿«å¾—åƒç›´æ¥æ ¹æ®ç´¢ä¹¦å·å»æ‹¿ä¹¦ã€‚

**è®¾è®¡æ”¶ç›Šå¯¹æ¯”**ï¼š

```java
// âŒ æ–¹æ¡ˆAï¼šçº¿æ€§æŸ¥æ‰¾ (æ²¡æœ‰åˆ©ç”¨ hashCode)
List<String> list = new ArrayList<>();
// ... å¡«å……100ä¸‡æ•°æ®
list.contains("Target"); // æ…¢ï¼éœ€è¦é€ä¸ª equals()

// âœ… æ–¹æ¡ˆBï¼šå“ˆå¸ŒæŸ¥æ‰¾ (åˆ©ç”¨ hashCode)
Set<String> set = new HashSet<>();
// ... å¡«å……100ä¸‡æ•°æ®
set.contains("Target"); // å¿«ï¼
// é€»è¾‘ï¼š
// 1. ç®— "Target".hashCode() -> å¾—åˆ°ç´¢å¼• 123
// 2. ç›´æ¥å»ç´¢å¼• 123 çœ‹æœ‰æ²¡æœ‰ä¸œè¥¿
// 3. åªæœ‰é‚£é‡Œæœ‰ä¸œè¥¿ï¼Œæ‰è°ƒç”¨ equals() ç¡®è®¤

```

**é€»è¾‘å›¾è§£**ï¼š

```
+----------------+      +----------------+
| çº¿æ€§æŸ¥æ‰¾ (List) |  vs  | å“ˆå¸ŒæŸ¥æ‰¾ (Map)  |
+----------------+      +----------------+
      |                        |
User A (equals?) -> No         |
User B (equals?) -> No      Calculate Hash
User C (equals?) -> Yes!       |
      ...                      v
(å¾ˆç´¯)                    Direct Access -> [User C]
                             (è½»æ¾)

```

---

### âš™ï¸ 1.5 åº•å±‚åŸç† *â­ è¿›é˜¶é€‰å­¦*

**ç›®æ ‡**ï¼šç†è§£ `hashCode` å¦‚ä½•æ˜ å°„åˆ°å†…å­˜ä½ç½®ï¼ˆä»¥ HashMap ä¸ºä¾‹ï¼‰ã€‚

**æ‰§è¡Œæµç¨‹**ï¼š
å½“æŠŠå¯¹è±¡æ”¾å…¥å“ˆå¸Œè¡¨æ—¶ï¼ŒJVM æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **è®¡ç®—å“ˆå¸Œ**ï¼šè°ƒç”¨å¯¹è±¡çš„ `hashCode()`ã€‚
2. **æ‰°åŠ¨å‡½æ•°**ï¼šå¯¹å“ˆå¸Œå€¼åšä½è¿ç®—ï¼ˆé˜²æ­¢ä½ä½ç›¸åŒå¯¼è‡´çš„å†²çªï¼‰ã€‚
3. **è®¡ç®—ç´¢å¼•**ï¼š`Index = HashCode % ArrayLength` (é€šå¸¸æ˜¯ä½è¿ç®— `&`).
4. **æ”¾å…¥æ¡¶ä¸­**ï¼šå°†å¯¹è±¡å­˜å…¥æ•°ç»„å¯¹åº”çš„ä½ç½®ã€‚

**å†…å­˜æ¨¡å‹ (Stack vs Heap)**ï¼š

```
Thread Stack                Heap Memory (HashMap Structure)
+----------------+         +-----------------------------------+
| key = "Key"    |         | Node[] table (æ•°ç»„)               |
| key.hashCode() |-------->| [0] null                          |
|   = 12345      |         | [1] --> [Node: "Key" | Value]     | <--- æ¡¶ (Bucket)
+----------------+         | [2] null                          |
                           | ...                               |
                           | [15] null                         |
                           +-----------------------------------+

```

**éªŒè¯ä»£ç  (ä¾›å‚è€ƒ)**ï¼š
ä½ å¯ä»¥æ‰“å°ä¸åŒå¯¹è±¡çš„å“ˆå¸Œå€¼ï¼Œè§‚å¯Ÿå®ƒä»¬çš„åˆ†å¸ƒæ˜¯å¦éšæœºã€‚å¦‚æœå“ˆå¸Œå€¼åˆ†å¸ƒä¸å‡ï¼ˆä¾‹å¦‚éƒ½è¿”å› 1ï¼‰ï¼ŒHashMap å°±ä¼šé€€åŒ–æˆé“¾è¡¨ï¼Œæ€§èƒ½ä»  è·Œè½è‡³ ã€‚

---

## ç¬¬2éƒ¨åˆ†ï¼šå·¥ç¨‹å®è·µï¼ˆHow to Do Rightï¼‰

### ğŸ” å‰ç½®çŸ¥è¯†æ£€æŸ¥

```
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“š å‰ç½®çŸ¥è¯†å›é¡¾
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æœ¬é˜¶æ®µä¼šç”¨åˆ°ä»¥ä¸‹æ¦‚å¿µï¼ˆå·²åœ¨é˜¶æ®µ1å­¦è¿‡ï¼‰ï¼š
Â· equalsä¸hashCodeçš„å¥‘çº¦ï¼šequalsç›¸ç­‰åˆ™hashå¿…é¡»ç›¸ç­‰
Â· å“ˆå¸Œå†²çªï¼šä¸åŒå¯¹è±¡å¯èƒ½æœ‰ç›¸åŒhash
Â· å†…å­˜æ¨¡å‹ï¼šHashMapå¦‚ä½•åˆ©ç”¨hashå®šä½Bucket

å¦‚æœä¸è®°å¾—äº†ï¼Œå»ºè®®å‘ä¸Šæ»‘åŠ¨å¤ä¹  1.2 èŠ‚ã€‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```

---

### ğŸŒ 2.1 çœŸå®åœºæ™¯ *ğŸ’¡ æ ¸å¿ƒå¿…å­¦*

**ç›®æ ‡**ï¼šç†è§£"ä¸ºä»€ä¹ˆç”¨ä½œ Map Key çš„å¯¹è±¡å¿…é¡»ä¸å¯å˜"ã€‚

**ä¸šåŠ¡åœºæ™¯**ï¼šæ„å»ºä¸€ä¸ª**æœ¬åœ°ç¼“å­˜ç³»ç»Ÿ**ï¼Œæ ¹æ®ç”¨æˆ·çš„"å¤åˆID"ï¼ˆåœ°åŒº+IDï¼‰å¿«é€ŸæŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯ã€‚

**âŒ å±é™©åšæ³•ï¼šä½¿ç”¨å¯å˜å¯¹è±¡åš Key**

è¿™æ˜¯ä¸€ä¸ªæå…¶éšè”½ä½†è‡´å‘½çš„ Bugã€‚å½“ä½ ä¿®æ”¹äº†å‚ä¸ Hash è®¡ç®—çš„å­—æ®µï¼Œå¯¹è±¡çš„ HashCode å°±ä¼šæ”¹å˜ï¼Œä½†å®ƒåœ¨ Map ä¸­çš„ä½ç½®ï¼ˆç´¢å¼•ï¼‰ä¸ä¼šè‡ªåŠ¨æ›´æ–°ã€‚

```java
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;

// è¿™æ˜¯ä¸€ä¸ªè®¾è®¡æœ‰ç¼ºé™·çš„ Key ç±»
class CompositeKey {
    // âŒ é”™è¯¯ï¼šå­—æ®µæ˜¯å¯å˜çš„ (æ²¡æœ‰ finalï¼Œä¸”æœ‰ setter)
    private String region;
    private long id;

    public CompositeKey(String region, long id) {
        this.region = region;
        this.id = id;
    }

    public void setRegion(String region) { this.region = region; }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        CompositeKey that = (CompositeKey) o;
        return id == that.id && Objects.equals(region, that.region);
    }

    @Override
    public int hashCode() {
        return Objects.hash(region, id);
    }
}

public class CacheDisaster {
    public static void main(String[] args) {
        Map<CompositeKey, String> userCache = new HashMap<>();
        
        CompositeKey key = new CompositeKey("CN", 1001);
        userCache.put(key, "User Data A");

        // æ­¤æ—¶ï¼šHash("CN", 1001) -> å­˜æ”¾åœ¨ Bucket X
        
        // âŒ ç¾éš¾æ—¶åˆ»ï¼šä¿®æ”¹äº†å‚ä¸ Hash è®¡ç®—çš„å­—æ®µ
        key.setRegion("US"); 
        // ç°åœ¨çš„ key.hashCode() å˜äº†ï¼
        
        // å°è¯•å–å›æ•°æ®
        // Map ä¼šå»æ–°çš„ Hash å¯¹åº”çš„ Bucket Y æ‰¾ï¼Œå½“ç„¶æ‰¾ä¸åˆ°ï¼
        String data = userCache.get(key); 
        
        System.out.println("èƒ½å–åˆ°æ•°æ®å—ï¼Ÿ" + (data != null)); // è¾“å‡ºï¼šfalse
        // ç»“æœï¼šæ•°æ®å°±åœ¨ Map é‡Œï¼ˆå†…å­˜æ³„æ¼ï¼‰ï¼Œä½†ä½ æ°¸è¿œæ‹¿ä¸åˆ°äº†ã€‚
    }
}

```

**é€»è¾‘å›¾è§£**ï¼š

```
[æ­¥éª¤1: put] Key(CN) -> Hash=10 -> æ”¾å…¥ Bucket[10]
      |
[æ­¥éª¤2: modify] Key.region å˜ä¸º "US"
      |
[æ­¥éª¤3: get] Key(US) -> è®¡ç®— Hash=20 -> å» Bucket[20] æ‰¾
      |                                      |
      v                                      v
   Keyå¯¹è±¡è¿˜åœ¨ Bucket[10] é‡Œ            Bucket[20] æ˜¯ç©ºçš„
   (è¿™å°±å«"è¿·å¤±çš„å¯¹è±¡")                  (è¿”å› null)

```

**âœ… æ­£ç¡®åšæ³•**ï¼šæ‰€æœ‰ç”¨äº Key çš„å­—æ®µå¿…é¡»æ˜¯ `final` çš„ã€‚

---

### âœ… 2.2 å·¥ç¨‹è§„èŒƒ *ğŸ”¥ å®æˆ˜å¿…å¤‡*

**ç›®æ ‡**ï¼šæŒæ¡ä¸šç•Œå…¬è®¤çš„ä»£ç æ ‡å‡†ï¼ˆçº¢ç»¿ç¯åˆ†çº§ï¼‰ã€‚

**ğŸ”´ REDï¼ˆå¼ºåˆ¶è§„èŒƒ - è¿åä¼šè¢«æ‰“å›ï¼‰**ï¼š

1. **æˆå¯¹é‡å†™**ï¼šé‡å†™äº† `equals` å¿…é¡»é‡å†™ `hashCode`ã€‚
* *åæœ*ï¼šHashSet/HashMap åŠŸèƒ½å¤±æ•ˆã€‚


2. **ä¸€è‡´æ€§**ï¼š`equals` ä¸­æœªä½¿ç”¨çš„å­—æ®µï¼Œç»ä¸å…è®¸å‡ºç°åœ¨ `hashCode` ä¸­ã€‚
* *åæœ*ï¼šæ‰“ç ´å¥‘çº¦ï¼ˆequalsç›¸ç­‰ä½†hashä¸ç­‰ï¼‰ã€‚


3. **ä¸è¦ç”¨éšæœºæ•°**ï¼š`hashCode` ä¸èƒ½åŒ…å« `random` æˆ– `System.currentTimeMillis()`ã€‚
* *åæœ*ï¼šæ¯æ¬¡è¿è¡Œç»“æœéƒ½ä¸ä¸€æ ·ï¼Œæ ¹æœ¬æ‰¾ä¸åˆ°å¯¹è±¡ã€‚



**ğŸŸ¢ GREENï¼ˆæ¨èé£æ ¼ï¼‰**ï¼š

1. **ä½¿ç”¨ä¸å¯å˜å¯¹è±¡**ï¼šä½œä¸º Map Key çš„ç±»ï¼Œå°½é‡è®¾è®¡æˆä¸å¯å˜ï¼ˆImmutableï¼‰ã€‚
2. **æ‡’åŠ è½½ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰**ï¼šå¦‚æœå¯¹è±¡ä¸å¯å˜ä¸”è®¡ç®— Hash å¼€é”€æå¤§ï¼ˆå¦‚è¶…é•¿å­—ç¬¦ä¸²ï¼‰ï¼Œå¯ä»¥ç¼“å­˜ `hash` å€¼ï¼ˆString ç±»å°±æ˜¯è¿™ä¹ˆåšçš„ï¼‰ã€‚

```java
// âœ… æ¨èèŒƒä¾‹ï¼šä¸å¯å˜ + æ ‡å‡† Hash
public final class ImmutableKey { // class æ˜¯ final
    private final String code;    // å­—æ®µæ˜¯ final
    private final int type;

    public ImmutableKey(String code, int type) {
        this.code = code;
        this.type = type;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof ImmutableKey)) return false;
        ImmutableKey that = (ImmutableKey) o;
        // é€»è¾‘ï¼šcode å’Œ type éƒ½ç›¸ç­‰æ‰ç®—ç›¸ç­‰
        return type == that.type && Objects.equals(code, that.code);
    }

    @Override
    public int hashCode() {
        // å¿…é¡»åŒ…å« equals ä¸­ç”¨åˆ°çš„æ‰€æœ‰å­—æ®µ
        return Objects.hash(code, type);
    }
}

```

---

### ğŸ”„ 2.3 ç‰ˆæœ¬æ¼”è¿› *ğŸ’¡ æ ¸å¿ƒå¿…å­¦*

**ç›®æ ‡**ï¼šçœ‹çœ‹ Java æ˜¯å¦‚ä½•ä¸€æ­¥æ­¥æŠŠå†™ `hashCode` å˜å¾—ç®€å•çš„ã€‚

**å¯¹æ¯”è¡¨æ ¼**ï¼š

| ç‰¹æ€§ | ä¼ ç»Ÿå†™æ³• (Java 7å‰) | æ ‡å‡†å†™æ³• (Java 7/8) | ç°ä»£å†™æ³• (Java 17+) |
| --- | --- | --- | --- |
| **ä»£ç é‡** | 10+ è¡Œ | 1 è¡Œ | **0 è¡Œ (è‡ªåŠ¨)** |
| **å¯è¯»æ€§** | å·® (å……æ–¥é­”æ•° 31) | ä¼˜ | å®Œç¾ |
| **æ˜“é”™æ€§** | é«˜ (å®¹æ˜“ç®—é”™) | ä½ | æ—  |
| **æ¨èåº¦** | âŒ æ·˜æ±° | âœ… å­˜é‡é¡¹ç›® | ğŸ”¥ æ–°é¡¹ç›®é¦–é€‰ |

#### 1. ä¼ ç»Ÿå†™æ³•ï¼ˆäº†è§£å³å¯ï¼Œçœ‹åˆ°åˆ«æ™•ï¼‰

ä½ éœ€è¦æ‰‹åŠ¨å¤„ç†è´¨æ•°ä¹˜æ³•ï¼Œè¿™æ˜¯ Effective Java æ—©æœŸç‰ˆæœ¬æ¨èçš„å†™æ³•ï¼Œç°åœ¨å·²ç”±å·¥å…·è‡ªåŠ¨ç”Ÿæˆã€‚

```java
@Override
public int hashCode() {
    int result = 17;
    result = 31 * result + (name != null ? name.hashCode() : 0);
    result = 31 * result + age;
    return result;
}

```

#### 2. æ ‡å‡†å†™æ³•ï¼ˆç›®å‰æœ€å¸¸è§ï¼‰

ä½¿ç”¨ `java.util.Objects.hash`ï¼Œè™½ç„¶ä¼šæœ‰è½»å¾®çš„è‡ªåŠ¨è£…ç®±æ€§èƒ½å¼€é”€ï¼Œä½†å¯¹äº 99% çš„ä¸šåŠ¡åœºæ™¯å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚

```java
@Override
public int hashCode() {
    return Objects.hash(name, age);
}

```

#### 3. ç°ä»£å†™æ³•ï¼ˆJava 17 Recordï¼‰*ğŸ”¥ å¼ºçƒˆæ¨è*

å¦‚æœæ˜¯çº¯æ•°æ®è½½ä½“ï¼ˆDTO, Keyï¼‰ï¼Œç›´æ¥ç”¨ `record`ã€‚

```java
// ç°ä»£å†™æ³•ï¼šå®šä¹‰ä¸€ä¸ª Record
// ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆï¼šæ„é€ å™¨ã€getterã€equalsã€hashCodeã€toString
public record UserKey(String region, long id) {
    // æ²¡é”™ï¼Œè¿™å°±å†™å®Œäº†ï¼
    // è¿™é‡Œçš„ hashCode å·²ç»å®Œç¾å®ç°äº†å·¥ç¨‹è§„èŒƒ
}

// éªŒè¯
UserKey k1 = new UserKey("CN", 100);
UserKey k2 = new UserKey("CN", 100);
System.out.println(k1.hashCode() == k2.hashCode()); // true

```

---

## ç¬¬3éƒ¨åˆ†ï¼šé¿å‘è¿›é˜¶ï¼ˆWhat to Avoid & Beyondï¼‰

### ğŸ” å‰ç½®çŸ¥è¯†æ£€æŸ¥

```
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“š å‰ç½®çŸ¥è¯†å›é¡¾
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æœ¬é˜¶æ®µä¼šç”¨åˆ°ä»¥ä¸‹æ¦‚å¿µï¼š
Â· å“ˆå¸Œå¥‘çº¦ï¼šequals ä¸ hashCode çš„è”åŠ¨ï¼ˆ1.2èŠ‚ï¼‰
Â· å¯å˜å¯¹è±¡çš„é£é™©ï¼šä¿®æ”¹å­—æ®µå¯¼è‡´å“ˆå¸Œå€¼æ”¹å˜ï¼ˆ2.1èŠ‚ï¼‰

å¦‚æœä¸è®°å¾—äº†ï¼Œå»ºè®®å›é¡¾å‰ä¸¤éƒ¨åˆ†ã€‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```

---

### âš ï¸ 3.1 å¸¸è§é™·é˜±åˆé›† *ğŸ”¥ å®æˆ˜å¿…å¤‡*

#### é™·é˜± 1ï¼šåŒå‘å¼•ç”¨çš„æ­»å¾ªç¯ï¼ˆStackOverflowErrorï¼‰

**ğŸ“š æ¶‰åŠåœºæ™¯**ï¼šJPA/Hibernate å®ä½“ç±»ï¼Œæˆ–è€…ä¹Ÿå°±æ˜¯çˆ¶å­çº§å¯¹è±¡äº’ç›¸æŒæœ‰å¼•ç”¨ã€‚

**æŠ¥é”™ç‰¹å¾**ï¼š

* `java.lang.StackOverflowError`
* ç¨‹åºç›´æ¥å´©æºƒï¼Œæ—¥å¿—æ˜¾ç¤º `hashCode` æ–¹æ³•æ— é™äº’ç›¸è°ƒç”¨ã€‚

**é”™è¯¯ä»£ç **ï¼š

```java
// åœºæ™¯ï¼šç”¨æˆ·(User)å’Œè®¢å•(Order)æ˜¯åŒå‘å…³ç³»
public class User {
    private String name;
    private List<Order> orders; // æŒæœ‰ Order åˆ—è¡¨

    @Override
    public int hashCode() {
        // âŒ å±é™©ï¼šè®¡ç®— Hash æ—¶åŒ…å«äº† orders
        return Objects.hash(name, orders); 
    }
}

public class Order {
    private String orderId;
    private User user; // æŒæœ‰ User å¼•ç”¨

    @Override
    public int hashCode() {
        // âŒ å±é™©ï¼šè®¡ç®— Hash æ—¶åŒ…å«äº† user
        return Objects.hash(orderId, user);
    }
}

```

**ä¸ºä»€ä¹ˆä¼šå´©**ï¼š

```
user.hashCode()
  â””â”€> åŒ…å« orders.hashCode()
        â””â”€> éå†æ¯ä¸ª order.hashCode()
              â””â”€> åŒ…å« user.hashCode()
                    â””â”€> å›åˆ°ç¬¬ä¸€æ­¥ (æ­»å¾ªç¯) ... ğŸ’¥

```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

```java
// âœ… ä¿®å¤ï¼šæ‰“ç ´å¾ªç¯é“¾
// åœ¨ hashCode ä¸­æ’é™¤æ‰"å¯¹é¢"çš„å¼•ç”¨ï¼Œé€šå¸¸åªä¿ç•™ ID æˆ–æ ¸å¿ƒå­—æ®µ
public class Order {
    @Override
    public int hashCode() {
        // åªè®¡ç®— IDï¼Œä¸å†å»åŠ¨ user å¯¹è±¡
        return Objects.hash(orderId);
    }
}

```

---

#### é™·é˜± 2ï¼šLombok çš„ç»§æ‰¿å‘

**ğŸ“š æ¶‰åŠå·¥å…·**ï¼šLombokï¼ˆJava å¼€å‘å¸¸ç”¨æ’ä»¶ï¼‰ã€‚

**ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºé”™**ï¼šå½“ä½ ä½¿ç”¨ `@Data` æˆ– `@EqualsAndHashCode` ä¸”å­˜åœ¨ç»§æ‰¿å…³ç³»æ—¶ã€‚Lombok é»˜è®¤**ä¸è°ƒç”¨**çˆ¶ç±»çš„ `hashCode`ã€‚

**é”™è¯¯ä»£ç **ï¼š

```java
@Data // Lombok è‡ªåŠ¨ç”Ÿæˆ equals/hashCode
class Parent {
    private int id;
}

@Data
@EqualsAndHashCode(callSuper = false) // âŒ é»˜è®¤æ˜¯ false
class Child extends Parent {
    private String name;
}

// åæœï¼š
Child c1 = new Child(); c1.setId(1); c1.setName("A");
Child c2 = new Child(); c2.setId(2); c2.setName("A");

// é€»è¾‘ä¸Š ID ä¸åŒåº”è¯¥æ˜¯ä¸åŒå¯¹è±¡
// ä½†å› ä¸º Lombok å¿½ç•¥äº†çˆ¶ç±» IDï¼Œåªçœ‹ nameï¼Œå¯¼è‡´åˆ¤å®šç›¸ç­‰ï¼
System.out.println(c1.equals(c2)); // ç»“æœï¼štrue (Bug!)

```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

```java
// âœ… ä¿®å¤ï¼šæ˜¾å¼å¼€å¯ callSuper
@Data
@EqualsAndHashCode(callSuper = true)
class Child extends Parent { ... }

```

---

### ğŸš€ 3.2 é«˜çº§æ¨¡å¼ï¼šå“ˆå¸Œç¼“å­˜ (Hash Caching) *â­ è¿›é˜¶é€‰å­¦*

**ç›®æ ‡**ï¼šå­¦ä¹  `java.lang.String` çš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§ã€‚

**é—®é¢˜åœºæ™¯**ï¼š
å¦‚æœä¸€ä¸ªå¯¹è±¡éå¸¸å¤æ‚ï¼ˆå­—æ®µå¤šã€å­—ç¬¦ä¸²é•¿ï¼‰ï¼Œé¢‘ç¹è®¡ç®— `hashCode` ä¼šæ¶ˆè€— CPUã€‚å¦‚æœè¿™ä¸ªå¯¹è±¡è¢«ç”¨ä½œ `Map` çš„ Keyï¼Œæ¯æ¬¡ `get()` éƒ½è¦é‡ç®—ï¼Œæ€§èƒ½å¾ˆå·®ã€‚

**æ¨¡å¼å®ç°**ï¼š
åˆ©ç”¨**å¯¹è±¡ä¸å¯å˜ï¼ˆImmutableï¼‰** çš„ç‰¹æ€§ï¼Œåªç®—ä¸€æ¬¡ï¼Œå­˜èµ·æ¥ä»¥åç›´æ¥ç”¨ã€‚

```java
public final class CachedHashKey {
    private final String massiveData;
    private final int id;
    
    // ç¼“å­˜ hash å€¼ï¼Œé»˜è®¤ä¸º 0
    private int hashCache = 0; 

    public CachedHashKey(String massiveData, int id) {
        this.massiveData = massiveData;
        this.id = id;
    }

    @Override
    public int hashCode() {
        int h = hashCache;
        // å¦‚æœ h æ˜¯ 0ï¼Œä¸”å¯¹è±¡å†…å­—æ®µä¸å…¨ä¸ºç©ºï¼ˆé¿å…çœŸçš„æ˜¯0çš„æƒ…å†µï¼‰ï¼Œåˆ™è¯´æ˜è¿˜æ²¡ç®—è¿‡
        if (h == 0) {
            // ç¬¬ä¸€æ¬¡è®¡ç®—ï¼Œå¼€é”€å¤§
            h = Objects.hash(massiveData, id);
            // å­˜å…¥ç¼“å­˜
            hashCache = h;
            System.out.println("ğŸ”¥ è§¦å‘é‡ç®—");
        }
        return h;
    }
}

```

**æ”¶ç›Šåˆ†æ**ï¼š

| ç»´åº¦ | æ™®é€šå†™æ³• | ç¼“å­˜å†™æ³• |
| --- | --- | --- |
| **é¦–æ¬¡è°ƒç”¨** | è€—æ—¶ 10ms | è€—æ—¶ 10ms |
| **åç»­è°ƒç”¨** | è€—æ—¶ 10ms | **è€—æ—¶ 0ms (ç›´æ¥è¿”å›)** |
| **é€‚ç”¨åœºæ™¯** | æ™®é€šä¸šåŠ¡å¯¹è±¡ | **é«˜é¢‘ä½¿ç”¨çš„ Map Key / String** |

---

### ğŸ“ 3.3 å®æˆ˜æŒ‘æˆ˜

**åœºæ™¯**ï¼šä½ æ­£åœ¨å¼€å‘ä¸€ä¸ª"åœ¨çº¿ä¹¦åº—çš„è´­ç‰©è½¦"åŠŸèƒ½ã€‚è´­ç‰©è½¦ä½¿ç”¨ `HashSet` æ¥è‡ªåŠ¨å»é‡ï¼ˆé˜²æ­¢åŒä¸€æœ¬ä¹¦è¢«æ·»åŠ ä¸¤æ¬¡ï¼‰ã€‚

**ç°çŠ¶**ï¼šç”¨æˆ·åé¦ˆï¼Œæ˜æ˜æŠŠä¸¤æœ¬ä¸åŒçš„ä¹¦åŠ è¿›å»äº†ï¼Œä½†è´­ç‰©è½¦é‡Œåªæ˜¾ç¤ºä¸€æœ¬ï¼›æˆ–è€…æœ‰æ—¶å€™ä¿®æ”¹äº†æ•°é‡ï¼Œä¹¦å°±æ— æ³•åˆ é™¤äº†ã€‚

**è¦æ±‚**ï¼š

1. æ‰¾å‡ºä»£ç ä¸­çš„ **2 ä¸ªè‡´å‘½ Bug**ã€‚
2. ä¿®å¤ä»£ç ï¼Œä½¿å…¶ç¬¦åˆ Java 17 æ ‡å‡†è§„èŒƒã€‚
3. ç¡®ä¿ `BookItem` åœ¨ `Set` ä¸­èƒ½æ­£ç¡®å·¥ä½œã€‚

```java
/**
 * è¯·ä¿®å¤ä»¥ä¸‹ä»£ç 
 */
import java.util.*;

public class BookItem {
    public String isbn; // ä¹¦å· (å”¯ä¸€æ ‡è¯†)
    public int quantity; // è´­ä¹°æ•°é‡

    public BookItem(String isbn, int quantity) {
        this.isbn = isbn;
        this.quantity = quantity;
    }

    // âŒ é—®é¢˜å°±åœ¨è¿™é‡Œ
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        BookItem bookItem = (BookItem) o;
        return quantity == bookItem.quantity && Objects.equals(isbn, bookItem.isbn);
    }

    @Override
    public int hashCode() {
        return Objects.hash(isbn, quantity);
    }
}

// æµ‹è¯•ç±»ï¼ˆä¸ç”¨æ”¹ï¼Œç”¨äºéªŒè¯ä½ çš„ä¿®å¤ï¼‰
class CartTest {
    public static void main(String[] args) {
        Set<BookItem> cart = new HashSet<>();
        BookItem item = new BookItem("978-7", 1);
        cart.add(item);
        
        // åœºæ™¯ï¼šç”¨æˆ·ä¿®æ”¹æ•°é‡
        item.quantity = 2; 
        
        // æœŸæœ›ï¼šè¿˜èƒ½æ‰¾åˆ°è¿™æœ¬ä¹¦å¹¶åˆ é™¤
        // å®é™…ï¼šåˆ ä¸æ‰ï¼å†…å­˜æ³„æ¼ï¼
        boolean removed = cart.remove(item);
        System.out.println("åˆ é™¤æˆåŠŸ? " + removed);
    }
}

```

ğŸ“ **è¯·æäº¤ä½ çš„ä¿®å¤ä»£ç ï¼ˆåªå†™ BookItem ç±»å³å¯ï¼‰**ã€‚

æˆ‘ä¼šè¿›è¡Œ Code Reviewï¼ŒæŒ‡å‡ºä½ æ˜¯å¦é¿å¼€äº†"å¯å˜å¯¹è±¡é™·é˜±"ä»¥åŠæ˜¯å¦ä½¿ç”¨äº†ç°ä»£è¯­æ³•ã€‚