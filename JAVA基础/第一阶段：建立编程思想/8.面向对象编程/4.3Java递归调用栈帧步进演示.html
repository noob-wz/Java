<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>Javaé€’å½’æ­¥è¿›å¯è§†åŒ–æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f7f6;
        }

        h3 {
            color: #007acc;
        }

        .code-explanation {
            width: 80%;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .code-explanation pre {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }

        #stack-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            border-left: 5px solid #007acc;
            padding-left: 20px;
            min-height: 400px;
        }

        .stack-frame {
            width: 250px;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #333;
            background-color: #e0f7fa;
            border-radius: 5px;
            text-align: center;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.5s ease-in-out;
        }

        .pushing {
            background-color: #a5d6a7;
            transform: scale(1.05);
        }

        .popping {
            background-color: #ffccbc;
            opacity: 0;
            transform: translateY(-20px);
        }

        .current-action {
            margin-top: 15px;
            font-weight: bold;
            color: #d32f2f;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 5px;
        }

        .disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        #resetBtn {
            background-color: #f44336;
        }
    </style>
</head>

<body>

    <h3>&#x2699; Javaé€’å½’è°ƒç”¨æ ˆå¸§æ­¥è¿›æ¼”ç¤º (test(10))</h3>

    <div class="code-explanation">
        <h4>å½“å‰æ‰§è¡Œé€»è¾‘ (è¢«é˜»å¡çš„æ‰“å°è¯­å¥ä½“ç°åè¿›å…ˆå‡º):</h4>
        <pre>
public static void test(int n) {
    if (n > 2) {
        test(n-1); // <--- å…³é”®ï¼šå½“å‰æ–¹æ³•æš‚åœï¼Œæ–°çš„æ ˆå¸§å‹å…¥
    }
    // åªæœ‰æ ˆå¸§å‡ºæ ˆæ—¶ï¼Œè¿™è¡Œä»£ç æ‰èƒ½æ‰§è¡Œ
    System.out.println("n=" + n); 
} 
        </pre>
        <div class="current-action" id="action-display">ç‚¹å‡» å¼€å§‹/é‡ç½® æŒ‰é’®è¿›è¡Œåˆå§‹åŒ–</div>
    </div>

    <div class="controls">
        <button id="startBtn" onclick="initDemo()">å¼€å§‹/é‡ç½®</button>
        <button id="stepBtn" onclick="stepDemo()" class="disabled">ä¸‹ä¸€æ­¥</button>
    </div>

    <h4>JVM è°ƒç”¨æ ˆ (Stack)</h4>
    <div id="stack-container">
    </div>

    <script>
        const stackContainer = document.getElementById('stack-container');
        const actionDisplay = document.getElementById('action-display');
        const startBtn = document.getElementById('startBtn');
        const stepBtn = document.getElementById('stepBtn');
        const MAX_N = 10;

        // --- å…¨å±€çŠ¶æ€æ§åˆ¶å¯¹è±¡ ---
        let control = {
            step: 0, // 0: åˆå§‹åŒ–, 1-9: å‹æ ˆ, 10-18: å‡ºæ ˆ
            state: 'IDLE', // IDLE, PUSHING, POPPING, DONE
            stack: [],
        };

        // --- æ ¸å¿ƒ Promise/Resolve æœºåˆ¶å®ç°æ­¥è¿› ---
        let resolver = null;
        function stepDemo() {
            if (resolver) {
                resolver(); // å”¤é†’ç­‰å¾…çš„ async å‡½æ•°
                resolver = null;
            }
        }
        function waitForStep() {
            return new Promise(resolve => {
                resolver = resolve;
            });
        }

        // --- åŠ¨ç”»/DOM æ“ä½œ ---
        function updateUI(message) {
            actionDisplay.innerHTML = `<strong>[æ­¥éª¤ ${control.step}]</strong> ${message}`;
        }
        function enableControls(enableStep) {
            stepBtn.classList.toggle('disabled', !enableStep);
            startBtn.textContent = 'é‡ç½®';
        }

        // --- é€’å½’è¿‡ç¨‹æ¨¡æ‹Ÿ ---

        async function pushFrame(n) {
            control.step++;
            updateUI(`å‹æ ˆï¼š è°ƒç”¨ test(${n})ã€‚å½“å‰æ ˆå¸§æš‚åœï¼Œç­‰å¾… test(${n - 1}) è¿”å›ã€‚`);

            await waitForStep(); // ç­‰å¾…ç”¨æˆ·ç‚¹å‡»ä¸‹ä¸€æ­¥

            const frame = document.createElement('div');
            frame.className = 'stack-frame pushing';
            frame.id = `frame-${n}`;
            frame.innerHTML = `<strong>æ ˆå¸§ ${n}</strong><br>å±€éƒ¨å˜é‡ n = ${n}`;

            // é¡¶éƒ¨å‹æ ˆ (åè¿›)
            stackContainer.prepend(frame);
            control.stack.push(frame);

            setTimeout(() => frame.classList.remove('pushing'), 300);
        }

        async function popFrame(n) {
            control.step++;

            const frameToPop = control.stack.pop();
            if (frameToPop) {

                // æ‰“å°è¯­å¥æ‰§è¡Œ
                updateUI(`å‡ºæ ˆï¼š æ ˆå¸§ ${n} ç»§ç»­æ‰§è¡Œ println("n=${n}")ï¼Œæ ˆå¸§é”€æ¯ã€‚`);

                await waitForStep(); // ç­‰å¾…ç”¨æˆ·ç‚¹å‡»ä¸‹ä¸€æ­¥

                // é”€æ¯åŠ¨ç”»
                frameToPop.classList.add('popping');
                setTimeout(() => frameToPop.remove(), 700);
            }
        }

        // --- é©±åŠ¨å‡½æ•° ---

        async function runDemo() {
            enableControls(true);

            // é˜¶æ®µä¸€ï¼šå‹æ ˆ (n=10 åˆ° n=3)
            control.state = 'PUSHING';
            for (let n = MAX_N; n > 2; n--) {
                await pushFrame(n);
            }

            // å‹å…¥ n=2 çš„æ ˆå¸§ï¼ˆé€’å½’ç»ˆæ­¢ï¼‰
            await pushFrame(2);
            updateUI(`ğŸš€ é€’å½’ç»ˆæ­¢ï¼š test(2) æ ˆå¸§å‹å…¥ã€‚n=2 ä¸æ»¡è¶³ (n > 2) æ¡ä»¶ï¼Œè·³è¿‡é€’å½’è°ƒç”¨ï¼Œå‡†å¤‡æ‰§è¡Œ printlnã€‚`);

            await waitForStep(); // è§‚å¯Ÿ n=2 æ ˆå¸§

            // é˜¶æ®µäºŒï¼šå‡ºæ ˆ (n=2 åˆ° n=10)
            control.state = 'POPPING';
            // ä» n=2 å¼€å§‹å‡ºæ ˆ (æ ˆé¡¶)
            for (let n = 2; n <= MAX_N; n++) {
                await popFrame(n);
            }

            // ç»“æŸ
            control.state = 'DONE';
            updateUI("ğŸ‰ æ¼”ç¤ºç»“æŸã€‚æ‰€æœ‰æ ˆå¸§å·²é”€æ¯ã€‚ç»“æœæ˜¯ 2 åˆ° 10 ä¾æ¬¡æ‰“å°ã€‚");
            enableControls(false);
            startBtn.classList.remove('disabled');
        }

        // åˆå§‹åŒ–/é‡ç½®å‡½æ•°
        function initDemo() {
            // é‡ç½® DOM
            stackContainer.innerHTML = '';

            // é‡ç½®çŠ¶æ€
            control = {
                step: 0,
                state: 'INIT',
                stack: [],
            };

            // ç¡®ä¿æŒ‰é’®å¯ç”¨
            enableControls(false);
            startBtn.textContent = 'å¼€å§‹æ¼”ç¤º';
            startBtn.classList.add('disabled');

            // å¯åŠ¨æ¼”ç¤ºæµç¨‹
            runDemo();
        }

    </script>
</body>

</html>