以下澄清 Java 语言中“表达式”、“副作用”、“返回值”等关键概念，并说明它们如何影响程序行为和 JVM/编译器优化。

## 一、 表达式与副作用的本质

在 Java 语言中，语句是程序的执行单元，而**表达式**是产生值的代码片段。表达式根据其是否改变程序状态，分为两大类：纯粹表达式和有副作用的表达式。

### 1\. 表达式的两个核心属性

所有 Java 表达式都具有（或尝试具有）以下两个属性：

|    属性    |                                     定义                                     |                                示例                                 |
| :--------: | :--------------------------------------------------------------------------: | :-----------------------------------------------------------------: |
| **返回值** | 表达式计算后**交付给程序使用的结果**（值）。几乎所有 Java 表达式都有返回值。 |             `5 * 3` 返回 `15`；`i++` 返回 `i` 的旧值。              |
| **副作用** |          表达式除了返回值之外，**对程序可观察状态造成的任何改变**。          | 改变变量值 (`a=5`)、I/O 操作 (`System.out.println`)、修改对象字段。 |

### 2\. 纯粹表达式 (Pure Expression)

**定义：** 只计算并返回一个值，**不改变任何程序状态**的表达式。在 Java 中，通常指调用 **纯方法（Pure Methods）** 产生的表达式。

|     表达式     |               行为                | **副作用** |                             **编译器/JIT 优化**                             |
| :------------: | :-------------------------------: | :--------: | :-------------------------------------------------------------------------: |
|    `a + b`     |      返回 $a$ 和 $b$ 的和。       |   **无**   |     如果返回值未被使用 (`a + b;`)，编译器/JIT 会**丢弃/忽略**这条语句。     |
| `Math.sqrt(x)` | 调用 `Math.sqrt` 方法并返回结果。 |   **无**   | 如果返回值未被使用 (`Math.sqrt(x);`)，JVM/JIT 会**丢弃/忽略**这条方法调用。 |

> **澄清：** 纯粹表达式**有返回值**，但**没有副作用**。如果它的返回值被丢弃（即没有赋值），那么整个语句对程序毫无影响，极有可能会被优化器删除。

### 3\. 有副作用的表达式

**定义：** 改变变量、执行 I/O 等影响程序状态的表达式。

|      表达式      |              行为               |               **副作用**               |                   **编译器/JIT 优化**                   |
| :--------------: | :-----------------------------: | :------------------------------------: | :-----------------------------------------------------: |
|     `a = 10`     | 返回 $10$，并将 $10$ 赋给 `a`。 |        **有**（改变 `a` 的值）         |  即使返回值未被使用，副作用仍需保留。**不能被丢弃。**   |
|      `i++`       |        返回 $i$ 的旧值。        |  **有**（在语句完成后改变 `i` 的值）   | 必须保留，因为 `i` 的值在内存中被修改。**不能被丢弃。** |
| `list.add(item)` |        返回 `boolean`。         | **有**（修改了 `list` 对象的内部状态） | 必须保留，因为它改变了堆上的对象状态。**不能被丢弃。**  |

> **澄清：** 有副作用的表达式 **既有返回值，又有副作用**。如果它的返回值被丢弃（即没有赋值），那么整个语句对程序毫无影响，极有可能会被优化器删除。

---

## 二、 总结对比：副作用、返回值

|              表达式类型               |             特征             |    有用性判断    |            编译器行为            |
| :-----------------------------------: | :--------------------------: | :--------------: | :------------------------------: |
|           **纯粹且未赋值**            | **无副作用**，返回值被丢弃。 |    **无意义**    |      **会被丢弃/优化掉**。       |
|           **纯粹且已赋值**            | **无副作用**，返回值被使用。 |    **有意义**    |            必须保留。            |
| **有副作用且未赋值（如前置自增/减）** | **有副作用**，返回值被丢弃。 |    **有意义**    | 必须保留，因为副作用改变了状态。 |
|            **后置自增/减**            | **有副作用**，返回**旧值**。 | **取决于上下文** |         必须保留副作用。         |

### 拓展总结：赋值表达式的副作用

赋值表达式 `num = a + b` 是一个复合表达式。

- **加法表达式 `(a + b)`** 是纯粹的，它不改变操作数 `a` 和 `b` 的状态。
- **赋值操作 `num = ...`** 是有副作用的，它的副作用是对左侧变量 `num` 的状态进行了修改。

这种区分使得 Java 编译器可以先安全地计算出纯粹的加法结果，然后执行赋值这一有副作用的操作。

> 总结：
>
> (1)所有的操作符在进行计算时，都只使用操作数提供的返回值
>
> **(2)副作用 是主动修改内存中的数据；而返回值 是被动的数据流，它需要通过赋值操作这一特定的副作用，才能间接修改内存。**
>
> (3)**副作用和返回值涉及的内存空间通常是不同的**：
>
> - 返回值占用的是操作数栈上的**临时空间** （或寄存器）。
> - 副作用改变的是**堆或栈上变量的内存空间** （例如实例变量、静态变量、局部变量等）。

为了深刻理解代码中副作用和返回值的区别，[结合自增/减，来看一段代码](./代码/AutoAdd.java)
